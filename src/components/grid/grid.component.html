<div class="relative w-full h-full flex items-center justify-center">
  <app-grid-indicator></app-grid-indicator>
  <div 
    class="grid gap-0.5 lg:gap-2 p-0.5 lg:p-2 bg-slate-100 dark:bg-slate-800 rounded-xl lg:rounded-2xl shadow-inner aspect-square w-full max-w-full max-h-full touch-none"
    [style]="gridStyles()"
    [class.pointer-events-none]="isShrinking()"
    (mouseleave)="onGridMouseLeave()"
    (mousemove)="onGridMouseMove($event)"
    (click)="onGridClick()"
    (touchstart)="onTouchStart($event)"
    (touchmove)="onTouchMove($event)"
    (touchend)="onTouchEnd($event)"
    (touchcancel)="onTouchEnd($event)"
    (tile-drag-move)="onTileDragMove($event)"
    (tile-drag-end)="onTileDragEnd($event)">
    @for (row of grid(); track $index; let r = $index) {
      @for (cell of row; track $index; let c = $index) {
        <div 
          class="w-full h-full relative overflow-hidden"
          [class]="getCellClass(r, c)">
          @if (getShapeForColor(grid()[r][c].color, r, c); as shape) {
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none"
                 [class]="getShapeColorClass(grid()[r][c].color, r, c)">
              @switch (shape) {
                @case ('square') {
                  <div class="w-3/4 h-3/4 rounded-sm"></div>
                }
                @case ('circle') {
                  <div class="w-3/4 h-3/4 rounded-full"></div>
                }
                @case ('triangle') {
                  <div class="w-3/4 h-3/4" style="clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                }
                @case ('cross') {
                  <div class="relative w-3/4 h-3/4">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-1/3"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-full w-1/3"></div>
                  </div>
                }
                @case ('star') {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3/4 h-3/4">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                }
              }
            </div>
          }
          @if(grid()[r][c].validated) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1/2 h-1/2 text-white/90 z-10">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
          }
        </div>
      }
    }
  </div>
  @if (isShrinking()) {
    <div class="absolute inset-0 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm flex items-center justify-center rounded-lg z-10">
       <p class="text-sm lg:text-xl font-bold text-red-600 dark:text-red-400 bg-white/80 dark:bg-slate-800/80 px-3 py-1.5 lg:px-4 lg:py-2 rounded-lg shadow-lg animate-pulse">{{ i18n.t().gridShrinking }}</p>
    </div>
  }
</div>