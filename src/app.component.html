<main class="w-full font-sans antialiased">

  <!-- ======================= -->
  <!-- == DESKTOP LAYOUT  == -->
  <!-- ======================= -->
  <div class="hidden lg:grid min-h-screen w-full max-w-screen-xl mx-auto grid-cols-[1fr_auto_1fr] gap-8 items-start p-8">
    
    <!-- == HEADER (Desktop) == -->
    <header class="w-full text-center mb-6 col-span-3 flex items-center justify-center gap-4">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Tileburst</h1>
        <app-language-selector></app-language-selector>
        <button 
          (click)="toggleSound()" 
          class="w-10 h-10 transition-all duration-200 btn-3d flex items-center justify-center rounded-full"
          [class.bg-slate-600]="!isSoundEnabled()"
          [class.bg-slate-400]="isSoundEnabled()"
          [style.--shadow-color]="isSoundEnabled() ? '#64748b' : '#475569'"
          [attr.aria-label]="i18n.t().toggleSound">
          @if (isSoundEnabled()) {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <path d="M11 5L6 9H2v6h4l5 4V5z"/>
              <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <path d="M11 5L6 9H2v6h4l5 4V5z"/>
              <line x1="23" y1="9" x2="17" y2="15"/>
              <line x1="17" y1="9" x2="23" y2="15"/>
            </svg>
          }
        </button>
        <button 
          (click)="toggleTheme()" 
          class="w-10 h-10 transition-all duration-200 btn-3d flex items-center justify-center rounded-full bg-slate-500 dark:bg-slate-600"
          [style.--shadow-color]="'#475569'"
          [attr.aria-label]="i18n.t().toggleDarkMode">
          @if (isDarkMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <circle cx="12" cy="12" r="4"/>
              <path d="M12 2v2"/>
              <path d="M12 20v2"/>
              <path d="m4.93 4.93 1.41 1.41"/>
              <path d="m17.66 17.66 1.41 1.41"/>
              <path d="M2 12h2"/>
              <path d="M20 12h2"/>
              <path d="m6.34 17.66-1.41 1.41"/>
              <path d="m19.07 4.93-1.41 1.41"/>
            </svg>
          }
        </button>
    </header>

    <!-- == PANNEAU GAUCHE (Desktop) == -->
    <aside class="flex flex-col gap-6 justify-self-end w-64">
      <!-- Score -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
        <div class="flex justify-center text-center">
          <div>
            <span class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold tracking-wider">{{ i18n.t().score }}</span>
            <p class="text-5xl font-bold text-amber-500">{{ score() }}</p>
          </div>
        </div>
      </div>
      <!-- Conseil Stratégique -->
      <div class="bg-cyan-100/60 dark:bg-cyan-900/60 rounded-2xl p-4 flex items-start gap-4">
        <div class="flex-shrink-0 bg-cyan-200/70 dark:bg-cyan-800/70 p-2 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-700 dark:text-cyan-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
        </div>
        <div class="text-cyan-900 dark:text-cyan-100">
          <h3 class="font-bold text-sm">{{ i18n.t().strategicTip }}</h3>
          <p class="text-sm leading-snug mt-1" [innerHTML]="i18n.translateWithParams('strategicTipText', minValidatedGroupSize().toString())"></p>
        </div>
      </div>
      <!-- Boutons d'action -->
      <div class="flex flex-col gap-3">
        <button 
          (click)="showTutorial()" 
          class="w-full bg-slate-500 text-white font-bold py-3 px-4 transition-all duration-200 btn-3d"
          style="--shadow-color: #475569;">
          {{ i18n.t().howToPlay }}
        </button>
        <button 
          (click)="restartGame()" 
          class="w-full bg-green-500 text-white font-bold py-3 px-4 transition-all duration-200 btn-3d"
          style="--shadow-color: #15803d;">
          {{ i18n.t().newGame }}
        </button>
      </div>
    </aside>

    <!-- == CENTRE (GRILLE) (Desktop) == -->
    <div class="w-[500px] max-w-full">
        <app-grid></app-grid>
    </div>

    <!-- == PANNEAU DROIT (Desktop) == -->
    <aside class="flex flex-col gap-6 justify-self-start w-64">
      <!-- Tuile Actuelle -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg flex flex-col items-center gap-4">
        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold tracking-wider">{{ i18n.t().currentTile }}</span>
        <div 
          class="flex-grow flex items-center justify-center w-full min-h-[120px] cursor-pointer touch-none"
          [class.opacity-50]="isDragging()"
          draggable="true"
          (click)="rotateTile()"
          (dragstart)="onDragStart($event)"
          (dragend)="onDragEnd()"
          (touchstart)="onTileTouchStart($event)"
          (touchmove)="onTileTouchMove($event)"
          (touchend)="onTileTouchEnd($event)"
          (touchcancel)="onTileTouchCancel()">
          @if (currentTile(); as tile) {
              <app-tile-preview [tile]="tile"></app-tile-preview>
          }
        </div>
      </div>
      <!-- Boutons d'action -->
      <div class="flex flex-col gap-3">
        <button 
          (click)="rotateTile()" 
          class="w-full bg-cyan-400 text-white font-bold py-3 px-4 transition-all duration-200 btn-3d"
          style="--shadow-color: #0891b2;">
          {{ i18n.t().rotate }}
        </button>
        <button 
          (click)="swapTiles()" 
          class="w-full bg-purple-400 text-white font-bold py-3 px-4 transition-all duration-200 btn-3d"
          style="--shadow-color: #9333ea;"
          [attr.aria-label]="i18n.t().swapTilesButton">
          <div class="flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
              <path d="M8 3 4 7l4 4"/>
              <path d="M4 7h16"/>
              <path d="m16 21 4-4-4-4"/>
              <path d="M20 17H4"/>
            </svg>
            {{ i18n.t().swap }}
          </div>
        </button>
      </div>
      <!-- Prochaine Tuile -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-lg flex flex-col items-center gap-2">
        <span class="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-semibold tracking-wider">{{ i18n.t().nextTile }}</span>
        <div class="flex-grow flex items-center justify-center min-h-[80px]">
            @if (nextTile(); as tile) { <app-tile-preview [tile]="tile"></app-tile-preview> }
        </div>
      </div>
    </aside>
  </div>


  <!-- ===================== -->
  <!-- == MOBILE LAYOUT   == -->
  <!-- ===================== -->
  <div class="flex lg:hidden w-full max-w-md h-[100svh] flex-col items-center p-2 mx-auto">
    <!-- Header (Mobile) -->
    <header class="w-full flex flex-col items-center gap-2 z-10 p-1">
      <div class="flex items-center justify-center gap-3">
        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight">Tileburst</h1>
        <app-language-selector></app-language-selector>
        <button 
          (click)="toggleSound()" 
          class="w-9 h-9 transition-all duration-200 btn-3d flex items-center justify-center rounded-full"
          [class.bg-slate-600]="!isSoundEnabled()"
          [class.bg-slate-400]="isSoundEnabled()"
          [style.--shadow-color]="isSoundEnabled() ? '#64748b' : '#475569'"
          [attr.aria-label]="i18n.t().toggleSound">
          @if (isSoundEnabled()) {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white">
              <path d="M11 5L6 9H2v6h4l5 4V5z"/>
              <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white">
              <path d="M11 5L6 9H2v6h4l5 4V5z"/>
              <line x1="23" y1="9" x2="17" y2="15"/>
              <line x1="17" y1="9" x2="23" y2="15"/>
            </svg>
          }
        </button>
        <button 
          (click)="toggleTheme()" 
          class="w-9 h-9 transition-all duration-200 btn-3d flex items-center justify-center rounded-full bg-slate-500 dark:bg-slate-600"
          [style.--shadow-color]="'#475569'"
          [attr.aria-label]="i18n.t().toggleDarkMode">
          @if (isDarkMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white">
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-white">
              <circle cx="12" cy="12" r="4"/>
              <path d="M12 2v2"/>
              <path d="M12 20v2"/>
              <path d="m4.93 4.93 1.41 1.41"/>
              <path d="m17.66 17.66 1.41 1.41"/>
              <path d="M2 12h2"/>
              <path d="M20 12h2"/>
              <path d="m6.34 17.66-1.41 1.41"/>
              <path d="m19.07 4.93-1.41 1.41"/>
            </svg>
          }
        </button>
      </div>
      
      <div class="w-full grid grid-cols-[auto_1fr_auto] items-center gap-2">
        <button 
          (click)="showRestartConfirm()" 
          class="w-11 h-11 bg-green-500 text-white transition-all duration-200 btn-3d flex items-center justify-center"
          style="--shadow-color: #15803d;"
          [attr.aria-label]="i18n.t().newGameButton">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
          </svg>
        </button>

        <div class="bg-white dark:bg-slate-800 rounded-2xl p-2 shadow-lg text-center">
          <span class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold tracking-wider">{{ i18n.t().score }}</span>
          <p class="text-3xl font-bold text-amber-500 leading-none">{{ score() }}</p>
        </div>

        <button 
          (click)="showTutorial()" 
          class="w-11 h-11 bg-slate-500 text-white transition-all duration-200 btn-3d flex items-center justify-center"
          style="--shadow-color: #475569;"
          [attr.aria-label]="i18n.t().howToPlayButton">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <path d="M12 17h.01"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Conseil Stratégique (Mobile) -->
    <div class="w-full bg-cyan-100/60 dark:bg-cyan-900/60 rounded-2xl p-3 flex items-start gap-3 mt-1">
      <div class="flex-shrink-0 bg-cyan-200/70 dark:bg-cyan-800/70 p-2 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-700 dark:text-cyan-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
      </div>
      <div class="text-cyan-900 dark:text-cyan-100 flex-1">
        <h3 class="font-bold text-xs">{{ i18n.t().strategicTip }}</h3>
        <p class="text-xs leading-snug mt-0.5" [innerHTML]="i18n.translateWithParams('strategicTipText', minValidatedGroupSize().toString())"></p>
      </div>
    </div>

    <!-- Grid (Mobile) -->
    <div class="w-full flex-grow flex items-center justify-center relative my-2">
      <div class="w-full max-w-full">
        <app-grid></app-grid>
      </div>
    </div>

    <!-- Footer Controls (Mobile) -->
    <footer class="w-full flex flex-col items-center gap-2 z-10 relative">
      <div class="w-full bg-slate-200/80 dark:bg-slate-700/80 backdrop-blur-sm p-2 rounded-2xl shadow-lg grid grid-cols-[1fr_auto_auto_1.75fr] items-center gap-2 h-[85px]">
        
        <div class="flex flex-col items-center justify-center h-full bg-white/50 dark:bg-slate-800/50 rounded-lg p-1">
          <span class="text-[10px] text-slate-600 dark:text-slate-300 uppercase font-semibold">{{ i18n.t().nextTile }}</span>
          <div class="flex-grow flex items-center justify-center">
            @if (nextTile(); as tile) { <app-tile-preview [tile]="tile"></app-tile-preview> }
          </div>
        </div>

        <button 
            (click)="swapTiles()" 
            class="h-full aspect-square bg-purple-400 text-white transition-all duration-200 btn-3d flex items-center justify-center"
            style="--shadow-color: #9333ea;"
            [attr.aria-label]="i18n.t().swapTilesButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
              <path d="M8 3 4 7l4 4"/>
              <path d="M4 7h16"/>
              <path d="m16 21 4-4-4-4"/>
              <path d="M20 17H4"/>
            </svg>
        </button>

        <button 
            (click)="rotateTile()" 
            class="h-full aspect-square bg-cyan-400 text-white transition-all duration-200 btn-3d flex items-center justify-center"
            style="--shadow-color: #0891b2;"
            [attr.aria-label]="i18n.t().rotateButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
              <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
            </svg>
        </button>

        <div 
          class="h-full w-full flex items-center justify-center bg-white/50 dark:bg-slate-800/50 rounded-lg cursor-grab active:cursor-grabbing touch-none select-none"
          [class.opacity-50]="isDragging()"
          draggable="true"
          (dragstart)="onDragStart($event)"
          (dragend)="onDragEnd()"
          (touchstart)="onTileTouchStart($event)"
          (touchmove)="onTileTouchMove($event)"
          (touchend)="onTileTouchEnd($event)"
          (touchcancel)="onTileTouchCancel()">
          @if (currentTile(); as tile) { <app-tile-preview [tile]="tile"></app-tile-preview> } @else { <div class="text-slate-500 dark:text-slate-400 text-sm">{{ i18n.t().loading }}</div> }
        </div>

      </div>
    </footer>
  </div>


  <!-- ===================== -->
  <!-- == SHARED MODALS   == -->
  <!-- ===================== -->
  @if (isRestartConfirmVisible()) {
    <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-2xl text-center flex flex-col gap-4 items-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100">{{ i18n.t().restartConfirm }}</h2>
        <p class="text-slate-600 dark:text-slate-300 text-base">{{ i18n.t().restartConfirmText }}</p>
        <div class="flex gap-4 mt-4 w-full">
            <button 
              (click)="hideRestartConfirm()" 
              class="w-full bg-slate-500 text-white font-bold py-3 px-6 transition-all duration-200 btn-3d"
              style="--shadow-color: #475569;">
              {{ i18n.t().no }}
            </button>
            <button 
              (click)="confirmAndRestart()" 
              class="w-full bg-green-500 text-white font-bold py-3 px-6 transition-all duration-200 btn-3d"
              style="--shadow-color: #15803d;">
              {{ i18n.t().yes }}
            </button>
        </div>
      </div>
    </div>
  }

  @if (isGameOver()) {
    <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 sm:p-8 shadow-2xl text-center flex flex-col gap-4 items-center max-w-md w-full">
        <h2 class="text-4xl sm:text-5xl font-extrabold text-red-500">{{ i18n.t().gameOver }}</h2>
        <p class="text-slate-600 dark:text-slate-300 text-base sm:text-lg">{{ i18n.t().finalScore }}</p>
        <p class="text-5xl sm:text-6xl font-bold text-amber-500">{{ score() }}</p>
        <div class="flex flex-col sm:flex-row gap-3 w-full mt-2">
          <button 
            (click)="shareScore()" 
            class="flex-1 bg-blue-500 text-white font-bold py-3 px-6 sm:px-8 text-base sm:text-lg transition-all duration-200 btn-3d flex items-center justify-center gap-2"
            style="--shadow-color: #2563eb;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
              <circle cx="18" cy="5" r="3"/>
              <circle cx="6" cy="12" r="3"/>
              <circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            {{ i18n.t().share }}
          </button>
          <button 
            (click)="restartGame()" 
            class="flex-1 bg-green-500 text-white font-bold py-3 px-6 sm:px-8 text-base sm:text-lg transition-all duration-200 btn-3d"
            style="--shadow-color: #15803d;">
            {{ i18n.t().playAgain }}
          </button>
        </div>
      </div>
    </div>
  }

  <app-tutorial></app-tutorial>
</main>